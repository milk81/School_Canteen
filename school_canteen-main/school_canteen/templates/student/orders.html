{% extends "base.html" %}

{% block title %}Мои заказы - Школьная столовая{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('student.dashboard') }}">Панель</a></li>
                <li class="breadcrumb-item active">Мои заказы</li>
            </ol>
        </nav>
        <h1>История заказов</h1>
        <p class="text-muted">Все ваши заказы питания</p>
    </div>
</div>

{% if orders %}
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Все заказы</h5>
            <span class="badge bg-primary">{{ orders|length }} заказов</span>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Дата</th>
                            <th>Время</th>
                            <th>Блюдо</th>
                            <th>Тип</th>
                            <th>Цена</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders|sort(attribute='date', reverse=True) %}
                        <tr>
                            <td>{{ order.date }}</td>
                            <td>{{ order.time }}</td>
                            <td>
                                <strong>
                                    {% if order.menu_item_name %}
                                        {{ order.menu_item_name }}
                                    {% else %}
                                        {{ order.type or order.meal_type|capitalize }}
                                    {% endif %}
                                </strong>
                                {% if order.menu_item and order.menu_item.description %}
                                    <br><small class="text-muted">{{ order.menu_item.description[:50] }}...</small>
                                {% endif %}
                            </td>
                            <td>
                                {% set meal_type = order.type or order.meal_type %}
                                <span class="badge {% if meal_type == 'breakfast' %}bg-success{% else %}bg-primary{% endif %}">
                                    {% if meal_type == 'breakfast' %}Завтрак{% else %}Обед{% endif %}
                                </span>
                            </td>
                            <td>{% if order.price %}{{ order.price }} ₽{% else %}—{% endif %}</td>
                            <td>
                                <span class="badge {% if order.status == 'ordered' %}bg-warning{% elif order.status == 'served' %}bg-success{% else %}bg-info{% endif %}">
                                    {% if order.status == 'ordered' %}Заказано
                                    {% elif order.status == 'prepared' %}Приготовлено
                                    {% elif order.status == 'served' %}Выдано
                                    {% elif order.status == 'issued' %}Выдано
                                    {% elif order.status == 'received' %}Получено
                                    {% else %}{{ order.status }}{% endif %}
                                </span>
                            </td>
                            <td>
                                {% if order.status in ['served','issued','prepared'] %}
                                    <form method="POST" action="{{ url_for('student.confirm_order', order_id=order.id) }}">
                                        <button type="submit" class="btn btn-sm btn-success me-2">
                                            <i class="fas fa-check me-1"></i>Получено
                                        </button>
                                    </form>
                                {% elif order.status == 'received' and order.menu_item_id %}
                                    <a href="{{ url_for('student.review', menu_item_id=order.menu_item_id) }}" 
                                       class="btn btn-sm btn-outline-warning">
                                        <i class="fas fa-star me-1"></i>Оставить отзыв
                                    </a>
                                {% else %}
                                    &nbsp;
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6>Статистика заказов</h6>
                            <div class="mb-2">
                                <span class="text-muted">Всего заказов:</span>
                                <span class="float-end fw-bold">{{ orders|length }}</span>
                            </div>
                            <div class="mb-2">
                                <span class="text-muted">Завтраков:</span>
                                <span class="float-end fw-bold">
                                    {{ orders|selectattr('type', 'equalto', 'breakfast')|list|length }}
                                </span>
                            </div>
                            <div class="mb-2">
                                <span class="text-muted">Обедов:</span>
                                <span class="float-end fw-bold">
                                    {{ orders|selectattr('type', 'equalto', 'lunch')|list|length }}
                                </span>
                            </div>
                            <div class="mb-2">
                                <span class="text-muted">Общая стоимость:</span>
                                <span class="float-end fw-bold text-success">
                                    {{ orders|sum(attribute='price') }} ₽
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6>Популярные блюда</h6>
                            {% set dish_counts = {} %}
                            {% for order in orders %}
                                {% set key = order.menu_item_name %}
                                {% if dish_counts.update({key: dish_counts.get(key, 0) + 1}) %}{% endif %}
                            {% endfor %}

                            {% for dish, count in dish_counts.items()|sort(attribute='1', reverse=True)[:3] %}
                                <div class="mb-2">
                                    <span class="text-muted">{{ dish }}:</span>
                                    <span class="float-end fw-bold">{{ count }} раз</span>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% else %}
    <div class="text-center py-5">
        <div class="mb-4">
            <i class="fas fa-shopping-basket fa-4x text-muted"></i>
        </div>
        <h4 class="text-muted">У вас еще нет заказов</h4>
        <p class="text-muted mb-4">Сделайте ваш первый заказ из меню!</p>
        <a href="{{ url_for('student.menu') }}" class="btn btn-primary btn-lg">
            <i class="fas fa-utensils me-2"></i>Посмотреть меню
        </a>
    </div>
{% endif %}
{% endblock %}